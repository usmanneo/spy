<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screen Mirror Web Client</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <style>
    body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; }
    video { width: 100%; max-width: 720px; object-fit: contain; background: #000; border: 2px solid #fff; }
    #status { position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0, 0, 0, 0.7); padding: 5px 10px; }
    button { position: absolute; bottom: 20px; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <div id="status">Waiting for stream...</div>
  <video id="remoteVideo" autoplay playsinline></video>
  <button id="playButton" style="display: none;">Play Video</button>

  <script>
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY", // Apna Firebase API key yahan daal do
      authDomain: "h4k3rspy-c4ab0.firebaseapp.com",
      databaseURL: "https://h4k3rspy-c4ab0-default-rtdb.firebaseio.com",
      projectId: "h4k3rspy-c4ab0",
      storageBucket: "h4k3rspy-c4ab0.firebasestorage.app",
      messagingSenderId: "833031176871",
      appId: "1:833031176871:web:11822e9543619f631f9182",
      measurementId: "G-KBEB9RBK56"
    };

    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    var configuration = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" }
      ]
    };
    var pc = new RTCPeerConnection(configuration);
    var remoteVideo = document.getElementById("remoteVideo");
    var statusDiv = document.getElementById("status");
    var playButton = document.getElementById("playButton");

    pc.ontrack = function(event) {
      console.log("Remote track received:", event.streams[0]);
      console.log("Track details:", event.track);
      statusDiv.textContent = "Stream received! Click Play to start.";
      remoteVideo.srcObject = event.streams[0];

      // Play button ke saath user interaction
      playButton.style.display = "block";
      playButton.onclick = function() {
        remoteVideo.play().then(() => {
          console.log("Video playing successfully");
          statusDiv.textContent = "Video playing";
          playButton.style.display = "none";
        }).catch(e => console.error("Video play failed:", e));
      };

      // Mute/unmute events handle karo
      event.track.onunmute = () => {
        console.log("Track unmuted, video should play now");
        statusDiv.textContent = "Video available! Playing...";
        if (playButton.style.display === "none") {
          remoteVideo.play().catch(e => console.error("Auto play failed after unmute:", e));
        }
      };
      event.track.onmute = () => {
        console.log("Track muted, video may be black");
        statusDiv.textContent = "Video paused (screen off on device)";
      };

      remoteVideo.onloadedmetadata = () => {
        console.log("Video metadata loaded:", remoteVideo.videoWidth, remoteVideo.videoHeight);
      };
    };

    pc.onicecandidate = function(event) {
      if (event.candidate) {
        console.log("Sending ICE candidate:", event.candidate);
        database.ref('signaling/iceCandidates').push(event.candidate.toJSON());
      }
    };

    pc.oniceconnectionstatechange = function() {
      console.log("ICE connection state:", pc.iceConnectionState);
      statusDiv.textContent = `ICE State: ${pc.iceConnectionState}`;
    };

    database.ref('signaling/offer').on('value', async function(snapshot) {
      var offerData = snapshot.val();
      if (offerData && pc.signalingState === 'stable') {
        console.log("Offer received:", offerData);
        statusDiv.textContent = "Processing offer...";
        try {
          await pc.setRemoteDescription(new RTCSessionDescription(offerData));
          var answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          console.log("Answer sent:", answer);
          database.ref('signaling/answer').set({
            type: answer.type,
            sdp: answer.sdp
          });
          database.ref('signaling/offer').remove();
        } catch (e) {
          console.error("Error processing offer:", e);
          statusDiv.textContent = "Error: " + e.message;
        }
      } else {
        console.log("Ignoring offer, signaling state:", pc.signalingState);
      }
    });

    database.ref('signaling/iceCandidates').on('child_added', function(snapshot) {
      var candidateData = snapshot.val();
      if (candidateData) {
        var candidate = new RTCIceCandidate({
          sdpMid: candidateData.sdpMid,
          sdpMLineIndex: candidateData.sdpMLineIndex,
          candidate: candidateData.candidate
        });
        console.log("Adding ICE candidate:", candidate);
        pc.addIceCandidate(candidate).catch(e => console.error("Error adding ICE:", e));
      }
    });

    window.onload = function() {
      console.log("Web client ready");
      statusDiv.textContent = "Waiting for stream...";
      database.ref('signaling/iceCandidates').remove();
    };

    window.onunload = function() {
      pc.close();
      database.ref('signaling').remove();
    };
  </script>
</body>
</html>
